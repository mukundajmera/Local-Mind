# ============================================================
# Sovereign Cognitive Engine - Production Compose Configuration
# ============================================================
#
# IMPORTANT: Run this inside the 'sovereign-ai' namespace:
#   nerdctl --namespace sovereign-ai compose up -d
#
# Or use the init.sh script which handles this automatically.
#
# SECURITY: Copy .env.example to .env and configure secrets
#   cp .env.example .env && chmod 600 .env
# ============================================================

name: sovereign-cognitive-engine

# =========================
# CUSTOM NETWORK
# =========================
networks:
  sovereign-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =========================
# PERSISTENT VOLUMES
# =========================
volumes:
  neo4j-data:
    driver: local
  milvus-data:
    driver: local
  redis-data:
    driver: local
  model-cache:
    driver: local

# =========================
# SERVICES
# =========================
services:
  # -------------------------
  # Redis Broker (Celery)
  # Pinned: redis:7.4.1-alpine3.20
  # -------------------------
  broker:
    image: redis:7.4.1-alpine3.20
    container_name: sce-broker
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  # -------------------------
  # Neo4j (Knowledge Graph)
  # Pinned: neo4j:5.26.0-community
  # -------------------------
  cognitive-brain:
    image: neo4j:5.26.0-community
    container_name: sce-cognitive-brain
    restart: unless-stopped
    ports:
      - "7474:7474"  # Browser
      - "7687:7687"  # Bolt
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL:-512m}
      NEO4J_dbms_memory_heap_max__size: ${NEO4J_HEAP_MAX:-1G}
      NEO4J_dbms_memory_pagecache_size: ${NEO4J_PAGECACHE:-512m}
    volumes:
      - neo4j-data:/data
      - ../../data/neo4j/logs:/logs
      - ../../data/neo4j/import:/import
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 120s

  # -------------------------
  # etcd (Milvus metadata)
  # Pinned: etcd:v3.5.16
  # -------------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.16
    container_name: sce-etcd
    restart: unless-stopped
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    volumes:
      - ../../data/milvus/etcd:/etcd
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # -------------------------
  # MinIO (Milvus storage)
  # Pinned: minio:RELEASE.2024-11-07T00-52-20Z
  # -------------------------
  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    container_name: sce-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY must be set}
    command: minio server /minio_data --console-address ":9001"
    volumes:
      - ../../data/milvus/minio:/minio_data
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # -------------------------
  # Milvus (Vector Database)
  # Pinned: milvus:v2.4.13
  # -------------------------
  memory-bank:
    image: milvusdb/milvus:v2.4.13
    container_name: sce-memory-bank
    restart: unless-stopped
    ports:
      - "19530:19530"  # Milvus gRPC
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY must be set}
    command: [ "milvus", "run", "standalone" ]
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9091/healthz || exit 1" ]
      interval: 15s
      timeout: 15s
      retries: 15
      start_period: 120s


  # -------------------------
  # Frontend Interface (TEMPORARILY DISABLED - build issue)
  # To re-enable: uncomment this section
  # -------------------------
  # interface:
  #   build:
  #     context: ../../apps/frontend
  #     dockerfile: Dockerfile
  #   container_name: sce-interface
  #   restart: unless-stopped
  #   environment:
  #     # Backend will run on host, not in container
  #     NEXT_PUBLIC_API_URL: http://localhost:8000
  #     NODE_ENV: ${NODE_ENV:-production}
  #   # ONLY the interface is exposed to the host
  #   ports:
  #     - "${INTERFACE_PORT:-3000}:3000"
  #   networks:
  #     - sovereign-net
  #   healthcheck:
  #     test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
  #     interval: 15s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 30s

