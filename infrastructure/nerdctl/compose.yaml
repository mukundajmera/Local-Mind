# ============================================================
# Sovereign Cognitive Engine - Production Compose Configuration
# ============================================================
#
# IMPORTANT: Run this inside the 'sovereign-ai' namespace:
#   nerdctl --namespace sovereign-ai compose up -d
#
# Or use the init.sh script which handles this automatically.
#
# SECURITY: Copy .env.example to .env and configure secrets
#   cp .env.example .env && chmod 600 .env
# ============================================================

name: sovereign-cognitive-engine

# =========================
# CUSTOM NETWORK
# =========================
networks:
  sovereign-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =========================
# PERSISTENT VOLUMES
# =========================
volumes:
  neo4j-data:
    driver: local
  milvus-data:
    driver: local
  redis-data:
    driver: local
  model-cache:
    driver: local

# =========================
# SERVICES
# =========================
services:
  # -------------------------
  # Redis Broker (Celery)
  # Pinned: redis:7.4.1-alpine3.20
  # -------------------------
  broker:
    image: redis:7.4.1-alpine3.20@sha256:c1e88455c85225310bbea54816e9c3f4b5295815e6dbf80c34d40afc6df28275
    container_name: sce-broker
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  # -------------------------
  # Neo4j (Knowledge Graph)
  # Pinned: neo4j:5.26.0-community
  # -------------------------
  cognitive-brain:
    image: neo4j:5.26.0-community@sha256:5a015e53de1895e7eee1574ae0325cf8c4b89587222778108c594bdd45a474b5
    container_name: sce-cognitive-brain
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL:-512m}
      NEO4J_dbms_memory_heap_max__size: ${NEO4J_HEAP_MAX:-1G}
      NEO4J_dbms_memory_pagecache_size: ${NEO4J_PAGECACHE:-512m}
    volumes:
      - neo4j-data:/data
      - ../../data/neo4j/logs:/logs
      - ../../data/neo4j/import:/import
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 60s

  # -------------------------
  # etcd (Milvus metadata)
  # Pinned: etcd:v3.5.16
  # -------------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.16@sha256:8523cb381f23c97b8a6a307f65282b212dd40a3b785442fa91621b983f1be079
    container_name: sce-etcd
    restart: unless-stopped
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    volumes:
      - ../../data/milvus/etcd:/etcd
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # -------------------------
  # MinIO (Milvus storage)
  # Pinned: minio:RELEASE.2024-11-07T00-52-20Z
  # -------------------------
  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z@sha256:ac591851803a79aee64bc37f66d77c56b0a4b6e12d9e5356380f4105510f2332
    container_name: sce-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY must be set}
    command: minio server /minio_data --console-address ":9001"
    volumes:
      - ../../data/milvus/minio:/minio_data
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # -------------------------
  # Milvus (Vector Database)
  # Pinned: milvus:v2.4.13
  # -------------------------
  memory-bank:
    image: milvusdb/milvus:v2.4.13@sha256:c02f0793c765bbb8d29f072581379a4ad85899e464996e6ccd563e03ac1d207a
    container_name: sce-memory-bank
    restart: unless-stopped
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY must be set}
    command: [ "milvus", "run", "standalone" ]
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9091/healthz || exit 1" ]
      interval: 15s
      timeout: 15s
      retries: 15
      start_period: 120s

  # -------------------------
  # Backend Orchestrator
  # -------------------------
  orchestrator:
    build:
      context: ../../apps/backend
      dockerfile: Dockerfile
    container_name: sce-orchestrator
    restart: unless-stopped
    depends_on:
      broker:
        condition: service_healthy
      cognitive-brain:
        condition: service_healthy
      memory-bank:
        condition: service_healthy
    environment:
      # Database connections (internal network)
      REDIS_URL: redis://broker:6379/0
      NEO4J_URI: bolt://cognitive-brain:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      MILVUS_HOST: memory-bank
      MILVUS_PORT: 19530
      # Service URLs
      VOICE_SERVICE_URL: http://acoustic-engine:8001
      # Runtime config
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # -------------------------
  # Celery Worker
  # -------------------------
  celery-worker:
    build:
      context: ../../apps/backend
      dockerfile: Dockerfile
    container_name: sce-celery-worker
    restart: unless-stopped
    depends_on:
      broker:
        condition: service_healthy
      orchestrator:
        condition: service_healthy
    command: celery -A tasks worker --loglevel=${LOG_LEVEL:-INFO} --concurrency=4
    environment:
      REDIS_URL: redis://broker:6379/0
      NEO4J_URI: bolt://cognitive-brain:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      MILVUS_HOST: memory-bank
      MILVUS_PORT: 19530
    networks:
      - sovereign-net

  # -------------------------
  # Acoustic Engine (TTS/Voice)
  # -------------------------
  acoustic-engine:
    build:
      context: ../../apps/voice-service
      dockerfile: Dockerfile
    container_name: sce-acoustic-engine
    restart: unless-stopped
    environment:
      TTS_MODEL: ${TTS_MODEL:-kokoro-82m}
      CUDA_VISIBLE_DEVICES: ${CUDA_VISIBLE_DEVICES:-0}
      TRANSFORMERS_CACHE: /app/models
    volumes:
      - model-cache:/app/models
    networks:
      - sovereign-net
    # CRITICAL: GPU passthrough - nerdctl Compose Specification compliant
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 90s

  # -------------------------
  # Frontend Interface
  # -------------------------
  interface:
    build:
      context: ../../apps/frontend
      dockerfile: Dockerfile
    container_name: sce-interface
    restart: unless-stopped
    depends_on:
      orchestrator:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://orchestrator:8000
      NODE_ENV: ${NODE_ENV:-production}
    # ONLY the interface is exposed to the host
    ports:
      - "${INTERFACE_PORT:-3000}:3000"
    networks:
      - sovereign-net
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
